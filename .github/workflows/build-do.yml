---
name: Build (DigitalOcean)

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  packer-digitalocean:
    runs-on: ubuntu-latest
    name: packer-digitalocean

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Install dependencies
        run: |
          # Install the package in development mode with uv
          uv pip install -e .
          # Install all dependencies
          uv pip install -r <(uv pip freeze)
      - name: Pre-build Ansible wrapper
        env:
          DO_API_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          ./vendor/ansible-wrapper.sh --version
          ./vendor/ansible-wrapper.sh vendor/digitalocean/pre-build.yaml
      - name: Install ansible roles
        run: |
          uv run ansible-galaxy install -p ./roles -r requirements.yml --verbose
      - uses: hashicorp/setup-packer@main
        with:
          version: "latest"
      - run: packer init .
      - run: packer validate -syntax-only .
      - run: packer build -color=false -force .
        env:
          AUTHENTIK_VERSION: 2025.6.1
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
