---
name: Build (DigitalOcean)

on:
  push:
    branches:
      - main

jobs:
  packer-digitalocean:
    runs-on: ubuntu-latest
    name: packer-digitalocean

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install ansible
        env:
          DO_API_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          pip install poetry
          poetry install
          ./vendor/ansible-wrapper.sh --version
          ./vendor/ansible-wrapper.sh vendor/digitalocean/pre-build.yaml
      - name: Install ansible roles
        run: |
          poetry run ansible-galaxy install -p ./roles -r requirements.yml --verbose
      - run: packer init .
      - run: packer validate -syntax-only .
      - run: packer build -color=false -on-error=abort -force .
        env:
          AUTHENTIK_VERSION: 2022.9.0
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
